import { BaseItem, enumColorToShortcode, globalConfig, smoothenDpi, THEME, types } from "../shapez.js";
import { SzInfo } from "./layer.js";
import { SzContext2D } from "./SzContext2D.js";
const colorCharList = ['r', 'g', 'b', '-'];
const colorStringList = colorCharList.flatMap(a => colorCharList.flatMap(b => colorCharList.map(c => `${a}${b}${c}`)));
const colorStringEnum = Object.fromEntries(colorStringList.map(e => [e, e]));
export class SzColorItem extends BaseItem {
    color;
    static getId() {
        return "sz-color";
    }
    static getSchema() {
        return types.enum(colorStringEnum);
    }
    serialize() {
        return this.color;
    }
    deserialize(data) {
        this.color = data;
    }
    getItemType() {
        return "color";
    }
    getAsCopyableKey() {
        return this.color;
    }
    equalsImpl(other) {
        return this.color === other.color;
    }
    constructor(color) {
        super();
        this.color = color;
    }
    cachedSprite;
    getBackgroundColorAsResource() {
        return THEME.map.resources[SzInfo.color.byChar[this.color[0]].name];
    }
    drawFullSizeOnCanvas(context, size) {
        // if (!this.cachedSprite) {
        // 	this.cachedSprite = Loader.getSprite("sprites/colors/" + this.color + ".png");
        // }
        // this.cachedSprite.drawCentered(context, size / 2, size / 2, size);
    }
    drawItemCenteredImpl(x, y, parameters, diameter) {
        const dpi = smoothenDpi(globalConfig.shapesSharpness * parameters.zoomLevel);
        const key = diameter + "/" + dpi + "/" + this.color;
        const canvas = parameters.root.buffers.getForKey({
            key: "shapedef",
            subKey: key,
            w: diameter,
            h: diameter,
            dpi,
            redrawMethod: this.internalGenerateShapeBuffer.bind(this),
        });
        parameters.context.drawImage(canvas, x - diameter / 2, y - diameter / 2, diameter, diameter);
    }
    internalGenerateShapeBuffer(canvas, ctx, w, h, dpi) {
        // prepare context
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';
        ctx.lineWidth = 0.05;
        ctx.translate((w * dpi) / 2, (h * dpi) / 2);
        ctx.scale((dpi * w) / 2.3, (dpi * h) / 2.3);
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';
        ctx.strokeStyle = THEME.items.outline;
        ctx.lineWidth = THEME.items.outlineWidth / 10;
        ctx.rotate(-Math.PI / 2);
        ctx.fillStyle = THEME.items.circleBackground;
        ctx.beginPath();
        ctx.arc(0, 0, 1.15, 0, 2 * Math.PI);
        ctx.fill();
        new SzContext2D(ctx).saved(ctx => {
            ctx.fillStyle = '#00000022';
            for (let c of this.color) {
                ctx.fillStyle = { r: 'red', g: 'green', b: 'blue', '-': '#eeeeee44' }[c];
                ctx.strokeStyle = 'black';
                ctx.lineWidth = 0.05;
                ctx.beginPath().arc(0, 0.5, 0.3, 0, 24).fill().stroke();
                ctx.rotate(8);
            }
        });
    }
    static fromColor(color) {
        let c = enumColorToShortcode[color];
        return new SzColorItem(c + c + c);
    }
    splitColor() {
        let c = '-';
        let s = this.color.replace(/[^-]/, C => (c = C, '-'));
        const color = { r: 'red', g: 'green', b: 'blue', '-': '-' }[c];
        let item = s == '---' ? null : new SzColorItem(s);
        return [color, item];
    }
    fillFromColor(other) {
        let s1 = this.color, s2 = other.color;
        while (s1.includes('-') && s2 != '---') {
            let l1 = s1.lastIndexOf('-');
            let c = '-';
            s2 = s2.replace(/[^-]/, C => (c = C, '-'));
            s1 = s1.replace(/-(?!.*-)/, c);
        }
        return [new SzColorItem(s1), s2 == '---' ? null : new SzColorItem(s2)];
    }
    splitIntoColors() {
        const toc = (c) => SzInfo.color.byChar[c].name;
        let s = this.color.split('').filter(e => e != '-');
        if (s.length == 0)
            return ['grey', null];
        if (s.length == 1)
            return [toc(s[0]), null];
        if (s.length == 2)
            return [toc(s[0]), toc(s[1])];
        s = s.sort();
        let c = SzInfo.color.byCombo[s.sort().join('')].name;
        return [c, c];
    }
    static install(mod) {
        mod.modInterface.registerItem(SzColorItem, data => new SzColorItem(data));
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29sb3IuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi90cy9zaGFwZXN0L2NvbG9yLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUNBLE9BQU8sRUFBZSxRQUFRLEVBQXlDLG9CQUFvQixFQUFFLFlBQVksRUFBTyxXQUFXLEVBQUUsS0FBSyxFQUFFLEtBQUssRUFBRSxNQUFNLGNBQWMsQ0FBQztBQUNoSyxPQUFPLEVBQWlDLE1BQU0sRUFBRSxNQUFNLFlBQVksQ0FBQztBQUNuRSxPQUFPLEVBQUUsV0FBVyxFQUFFLE1BQU0sa0JBQWtCLENBQUM7QUFFL0MsTUFBTSxhQUFhLEdBQWdCLENBQUMsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxDQUFDLENBQUM7QUFDeEQsTUFBTSxlQUFlLEdBQ3BCLGFBQWEsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FDekIsYUFBYSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUN6QixhQUFhLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQ3JCLEdBQUcsQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLEVBQWlCLENBQUMsQ0FBQyxDQUFDLENBQUM7QUFDckMsTUFBTSxlQUFlLEdBQUcsTUFBTSxDQUFDLFdBQVcsQ0FBQyxlQUFlLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO0FBRzdFLE1BQU0sT0FBTyxXQUFZLFNBQVEsUUFBUTtJQUN4QyxLQUFLLENBQWU7SUFDcEIsTUFBTSxDQUFDLEtBQUs7UUFDWCxPQUFPLFVBQVUsQ0FBQztJQUNuQixDQUFDO0lBQ0QsTUFBTSxDQUFDLFNBQVM7UUFDZixPQUFPLEtBQUssQ0FBQyxJQUFJLENBQUMsZUFBZSxDQUFDLENBQUM7SUFDcEMsQ0FBQztJQUNELFNBQVM7UUFDUixPQUFPLElBQUksQ0FBQyxLQUFLLENBQUM7SUFD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TyxJQUFJLFdBQVcsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQVEsQ0FBQyxDQUFDO0lBQzFDLENBQUM7SUFFRCxVQUFVO1FBQ1QsSUFBSSxDQUFDLEdBQUcsR0FBRyxDQUFDO1FBQ1osSUFBSSxDQUFDLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsTUFBTSxFQUFFLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxFQUFFLEdBQUcsQ0FBQyxDQUFDLENBQUM7UUFDdEQsTUFBTSxLQUFLLEdBQUcsRUFBRSxDQUFDLEVBQUUsS0FBSyxFQUFFLENBQUMsRUFBRSxPQUFPLEVBQUUsQ0FBQyxFQUFFLE1BQU0sRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFLENBQUMsQ0FBQyxDQUFFLENBQUM7UUFDaEUsSUFBSSxJQUFJLEdBQUcsQ0FBQyxJQUFJLEtBQUssQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxJQUFJLFdBQVcsQ0FBQyxDQUFRLENBQUMsQ0FBQztRQUN6RCxPQUFPLENBQUMsS0FBSyxFQUFFLElBQUksQ0FBQyxDQUFDO0lBQ3RCLENBQUM7SUFFRCxhQUFhLENBQUMsS0FBa0I7UUFDL0IsSUFBSSxFQUFFLEdBQVcsSUFBSSxDQUFDLEtBQUssRUFBRSxFQUFFLEdBQVcsS0FBSyxDQUFDLEtBQUssQ0FBQztRQUN0RCxPQUFPLEVBQUUsQ0FBQyxRQUFRLENBQUMsR0FBRyxDQUFDLElBQUksRUFBRSxJQUFJLEtBQUssRUFBRTtZQUN2QyxJQUFJLEVBQUUsR0FBRyxFQUFFLENBQUMsV0FBVyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1lBQzdCLElBQUksQ0FBQyxHQUFHLEdBQUcsQ0FBQztZQUNaLEVBQUUsR0FBRyxFQUFFLENBQUMsT0FBTyxDQUFDLE1BQU0sRUFBRSxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsRUFBRSxHQUFHLENBQUMsQ0FBQyxDQUFDO1lBQzNDLEVBQUUsR0FBRyxFQUFFLENBQUMsT0FBTyxDQUFDLFVBQVUsRUFBRSxDQUFDLENBQUMsQ0FBQztTQUMvQjtRQUNELE9BQU8sQ0FBQyxJQUFJLFdBQVcsQ0FBQyxFQUFTLENBQUMsRUFBRSxFQUFFLElBQUksS0FBSyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxDQUFDLElBQUksV0FBVyxDQUFDLEVBQVMsQ0FBQyxDQUFDLENBQUM7SUFDdEYsQ0FBQztJQUVELGVBQWU7UUFDZCxNQUFNLEdBQUcsR0FBRyxDQUFDLENBQVMsRUFBRSxFQUFFLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFBO1FBQ3RELElBQUksQ0FBQyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLEVBQUUsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsSUFBSSxHQUFHLENBQUMsQ0FBQztRQUNuRCxJQUFJLENBQUMsQ0FBQyxNQUFNLElBQUksQ0FBQztZQUFFLE9BQU8sQ0FBQyxNQUFNLEVBQUUsSUFBSSxDQUFDLENBQUM7UUFDekMsSUFBSSxDQUFDLENBQUMsTUFBTSxJQUFJLENBQUM7WUFBRSxPQUFPLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxFQUFFLElBQUksQ0FBQyxDQUFDO1FBQzVDLElBQUksQ0FBQyxDQUFDLE1BQU0sSUFBSSxDQUFDO1lBQUUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFBRSxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUNqRCxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksRUFBRSxDQUFDO1FBQ2IsSUFBSSxDQUFDLEdBQUcsTUFBTSxDQUFDLEtBQUssQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLElBQUksRUFBRSxDQUFDLElBQUksQ0FBQyxFQUFFLENBQWdCLENBQUMsQ0FBQyxJQUFJLENBQUM7UUFDcEUsT0FBTyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQztJQUNmLENBQUM7SUFFRCxNQUFNLENBQUMsT0FBTyxDQUFDLEdBQVE7UUFDdEIsR0FBRyxDQUFDLFlBQVksQ0FBQyxZQUFZLENBQUMsV0FBVyxFQUFFLElBQUksQ0FBQyxFQUFFLENBQUMsSUFBSSxXQUFXLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQztJQUMzRSxDQUFDO0NBQ0QiLCJzb3VyY2VzQ29udGVudCI6WyJcclxuaW1wb3J0IHsgQXRsYXNTcHJpdGUsIEJhc2VJdGVtLCBDb2xvckl0ZW0sIERyYXdQYXJhbWV0ZXJzLCBlbnVtQ29sb3JzLCBlbnVtQ29sb3JUb1Nob3J0Y29kZSwgZ2xvYmFsQ29uZmlnLCBNb2QsIHNtb290aGVuRHBpLCBUSEVNRSwgdHlwZXMgfSBmcm9tIFwiLi4vc2hhcGV6LmpzXCI7XHJcbmltcG9ydCB7IGNvbG9yLCBjb2xvckNoYXIsIGNvbG9yU3RyaW5nLCBTekluZm8gfSBmcm9tIFwiLi9sYXllci5qc1wiO1xyXG5pbXBvcnQgeyBTekNvbnRleHQyRCB9IGZyb20gXCIuL1N6Q29udGV4dDJELmpzXCI7XHJcblxyXG5jb25zdCBjb2xvckNoYXJMaXN0OiBjb2xvckNoYXJbXSA9IFsncicsICdnJywgJ2InLCAnLSddO1xyXG5jb25zdCBjb2xvclN0cmluZ0xpc3QgPVxyXG5cdGNvbG9yQ2hhckxpc3QuZmxhdE1hcChhID0+XHJcblx0XHRjb2xvckNoYXJMaXN0LmZsYXRNYXAoYiA9PlxyXG5cdFx0XHRjb2xvckNoYXJMaXN0Lm1hcChjID0+XHJcblx0XHRcdFx0YCR7YX0ke2J9JHtjfWAgYXMgY29sb3JTdHJpbmcpKSk7XHJcbmNvbnN0IGNvbG9yU3RyaW5nRW51bSA9IE9iamVjdC5mcm9tRW50cmllcyhjb2xvclN0cmluZ0xpc3QubWFwKGUgPT4gW2UsIGVdKSk7XHJcblxyXG5cclxuZXhwb3J0IGNsYXNzIFN6Q29sb3JJdGVtIGV4dGVuZHMgQmFzZUl0ZW0gaW1wbGVtZW50cyBDb2xvckl0ZW0ge1xyXG5cdGNvbG9yITogY29sb3JTdHJpbmc7XHJcblx0c3RhdGljIGdldElkKCkge1xyXG5cdFx0cmV0dXJuIFwic3otY29sb3JcIjtcclxuXHR9XHJcblx0c3RhdGljIGdldFNjaGVtYSgpIHtcclxuXHRcdHJldHVybiB0eXBlcy5lbnVtKGNvbG9yU3RyaW5nRW51bSk7XHJcblx0fVxyXG5cdHNlcmlhbGl6ZSgpIHtcclxuXHRcdHJldHVybiB0aGlzLmNvbG9yO1xyXG5cdH1cclxuXHRkZXNlcmlhbGl6ZShkYXRhOiBhbnkpIHtcclxuXHRcdHRoaXMuY29sb3IgPSBkYXRhO1xyXG5cdH1cclxuXHRnZXRJdGVtVHlwZSgpIHtcclxuXHRcdHJldHVybiBcImNvbG9yXCIgYXMgY29uc3Q7XHJcblx0fVxyXG5cdGdldEFzQ29weWFibGVLZXkoKSB7XHJcblx0XHRyZXR1cm4gdGhpcy5jb2xvcjtcclxuXHR9XHJcblx0ZXF1YWxzSW1wbChvdGhlcjogQmFzZUl0ZW0pIHtcclxuXHRcdHJldHVybiB0aGlzLmNvbG9yID09PSAob3RoZXIgYXMgYW55IGFzIFN6Q29sb3JJdGVtKS5jb2xvcjtcclxuXHR9XHJcblx0Y29uc3RydWN0b3IoY29sb3I6IGNvbG9yU3RyaW5nKSB7XHJcblx0XHRzdXBlcigpO1xyXG5cdFx0dGhpcy5jb2xvciA9IGNvbG9yO1xyXG5cdH1cclxuXHRjYWNoZWRTcHJpdGUhOiBBdGxhc1Nwcml0ZTtcclxuXHRnZXRCYWNrZ3JvdW5kQ29sb3JBc1Jlc291cmNlKCkge1xyXG5cdFx0cmV0dXJuIFRIRU1FLm1hcC5yZXNvdXJjZXNbXHJcblx0XHRcdFN6SW5mby5jb2xvci5ieUNoYXJbdGhpcy5jb2xvclswXV0ubmFtZVxyXG5cdFx0XTtcclxuXHR9XHJcblx0ZHJhd0Z1bGxTaXplT25DYW52YXMoY29udGV4dDogQ2FudmFzUmVuZGVyaW5nQ29udGV4dDJELCBzaXplOiBudW1iZXIpIHtcclxuXHRcdC8vIGlmICghdGhpcy5jYWNoZWRTcHJpdGUpIHtcclxuXHRcdC8vIFx0dGhpcy5jYWNoZWRTcHJpdGUgPSBMb2FkZXIuZ2V0U3ByaXRlKFwic3ByaXRlcy9jb2xvcnMvXCIgKyB0aGlzLmNvbG9yICsgXCIucG5nXCIpO1xyXG5cdFx0Ly8gfVxyXG5cdFx0Ly8gdGhpcy5jYWNoZWRTcHJpdGUuZHJhd0NlbnRlcmVkKGNvbnRleHQsIHNpemUgLyAyLCBzaXplIC8gMiwgc2l6ZSk7XHJcblx0fVxyXG5cdGRyYXdJdGVtQ2VudGVyZWRJbXBsKHg6IG51bWJlciwgeTogbnVtYmVyLCBwYXJhbWV0ZXJzOiBEcmF3UGFyYW1ldGVycywgZGlhbWV0ZXI6IG51bWJlcik6IHZvaWQge1xyXG5cdFx0Y29uc3QgZHBpID0gc21vb3RoZW5EcGkoZ2xvYmFsQ29uZmlnLnNoYXBlc1NoYXJwbmVzcyAqIHBhcmFtZXRlcnMuem9vbUxldmVsKTtcclxuXHRcdGNvbnN0IGtleSA9IGRpYW1ldGVyICsgXCIvXCIgKyBkcGkgKyBcIi9cIiArIHRoaXMuY29sb3I7XHJcblx0XHRjb25zdCBjYW52YXMgPSBwYXJhbWV0ZXJzLnJvb3QuYnVmZmVycy5nZXRGb3JLZXkoe1xyXG5cdFx0XHRrZXk6IFwic2hhcGVkZWZcIixcclxuXHRcdFx0c3ViS2V5OiBrZXksXHJcblx0XHRcdHc6IGRpYW1ldGVyLFxyXG5cdFx0XHRoOiBkaWFtZXRlcixcclxuXHRcdFx0ZHBpLFxyXG5cdFx0XHRyZWRyYXdNZXRob2Q6IHRoaXMuaW50ZXJuYWxHZW5lcmF0ZVNoYXBlQnVmZmVyLmJpbmQodGhpcyksXHJcblx0XHR9KTtcclxuXHRcdHBhcmFtZXRlcnMuY29udGV4dC5kcmF3SW1hZ2UoY2FudmFzLCB4IC0gZGlhbWV0ZXIgLyAyLCB5IC0gZGlhbWV0ZXIgLyAyLCBkaWFtZXRlciwgZGlhbWV0ZXIpO1xyXG5cclxuXHR9XHJcblxyXG5cclxuXHRpbnRlcm5hbEdlbmVyYXRlU2hhcGVCdWZmZXIoY2FudmFzOiBIVE1MQ2FudmFzRWxlbWVudCwgY3R4OiBDYW52YXNSZW5kZXJpbmdDb250ZXh0MkQsIHc6IG51bWJlciwgaDogbnVtYmVyLCBkcGk6IG51bWJlcik6IHZvaWQge1xyXG5cdFx0Ly8gcHJlcGFyZSBjb250ZXh0XHJcblx0XHRjdHgubGluZUNhcCA9ICdyb3VuZCc7XHJcblx0XHRjdHgubGluZUpvaW4gPSAncm91bmQnO1xyXG5cdFx0Y3R4LmxpbmVXaWR0aCA9IDAuMDU7XHJcblxyXG5cdFx0Y3R4LnRyYW5zbGF0ZSgodyAqIGRwaSkgLyAyLCAoaCAqIGRwaSkgLyAyKTtcclxuXHRcdGN0eC5zY2FsZSgoZHBpICogdykgLyAyLjMsIChkcGkgKiBoKSAvIDIuMyk7XHJcblx0XHRjdHgubGluZUNhcCA9ICdyb3VuZCc7XHJcblx0XHRjdHgubGluZUpvaW4gPSAncm91bmQnO1xyXG5cdFx0Y3R4LnN0cm9rZVN0eWxlID0gVEhFTUUuaXRlbXMub3V0bGluZTtcclxuXHRcdGN0eC5saW5lV2lkdGggPSBUSEVNRS5pdGVtcy5vdXRsaW5lV2lkdGggLyAxMDtcclxuXHJcblx0XHRjdHgucm90YXRlKC1NYXRoLlBJIC8gMik7XHJcblxyXG5cdFx0Y3R4LmZpbGxTdHlsZSA9IFRIRU1FLml0ZW1zLmNpcmNsZUJhY2tncm91bmQ7XHJcblx0XHRjdHguYmVnaW5QYXRoKCk7XHJcblx0XHRjdHguYXJjKDAsIDAsIDEuMTUsIDAsIDIgKiBNYXRoLlBJKTtcclxuXHRcdGN0eC5maWxsKCk7XHJcblxyXG5cdFx0bmV3IFN6Q29udGV4dDJEKGN0eCkuc2F2ZWQoY3R4ID0+IHtcclxuXHRcdFx0Y3R4LmZpbGxTdHlsZSA9ICcjMDAwMDAwMjInO1xyXG5cdFx0XHRmb3IgKGxldCBjIG9mIHRoaXMuY29sb3IpIHtcclxuXHRcdFx0XHRjdHguZmlsbFN0eWxlID0geyByOiAncmVkJywgZzogJ2dyZWVuJywgYjogJ2JsdWUnLCAnLSc6ICcjZWVlZWVlNDQnIH1bY10hO1xyXG5cdFx0XHRcdGN0eC5zdHJva2VTdHlsZSA9ICdibGFjayc7XHJcblx0XHRcdFx0Y3R4LmxpbmVXaWR0aCA9IDAuMDU7XHJcblx0XHRcdFx0Y3R4LmJlZ2luUGF0aCgpLmFyYygwLCAwLjUsIDAuMywgMCwgMjQpLmZpbGwoKS5zdHJva2UoKTtcclxuXHRcdFx0XHRjdHgucm90YXRlKDgpO1xyXG5cdFx0XHR9XHJcblx0XHR9KTtcclxuXHR9XHJcblxyXG5cdHN0YXRpYyBmcm9tQ29sb3IoY29sb3I6IGVudW1Db2xvcnMpIHtcclxuXHRcdGxldCBjID0gZW51bUNvbG9yVG9TaG9ydGNvZGVbY29sb3JdO1xyXG5cdFx0cmV0dXJuIG5ldyBTekNvbG9ySXRlbShjICsgYyArIGMgYXMgYW55KTtcclxuXHR9XHJcblxyXG5cdHNwbGl0Q29sb3IoKTogW2VudW1Db2xvcnMsIFN6Q29sb3JJdGVtIHwgbnVsbF0ge1xyXG5cdFx0bGV0IGMgPSAnLSc7XHJcblx0XHRsZXQgcyA9IHRoaXMuY29sb3IucmVwbGFjZSgvW14tXS8sIEMgPT4gKGMgPSBDLCAnLScpKTtcclxuXHRcdGNvbnN0IGNvbG9yID0geyByOiAncmVkJywgZzogJ2dyZWVuJywgYjogJ2JsdWUnLCAnLSc6ICctJyB9W2NdITtcclxuXHRcdGxldCBpdGVtID0gcyA9PSAnLS0tJyA/IG51bGwgOiBuZXcgU3pDb2xvckl0ZW0ocyBhcyBhbnkpO1xyXG5cdFx0cmV0dXJuIFtjb2xvciwgaXRlbV07XHJcblx0fVxyXG5cclxuXHRmaWxsRnJvbUNvbG9yKG90aGVyOiBTekNvbG9ySXRlbSk6IFtTekNvbG9ySXRlbSwgU3pDb2xvckl0ZW0gfCBudWxsXSB7XHJcblx0XHRsZXQgczE6IHN0cmluZyA9IHRoaXMuY29sb3IsIHMyOiBzdHJpbmcgPSBvdGhlci5jb2xvcjtcclxuXHRcdHdoaWxlIChzMS5pbmNsdWRlcygnLScpICYmIHMyICE9ICctLS0nKSB7XHJcblx0XHRcdGxldCBsMSA9IHMxLmxhc3RJbmRleE9mKCctJyk7XHJcblx0XHRcdGxldCBjID0gJy0nO1xyXG5cdFx0XHRzMiA9IHMyLnJlcGxhY2UoL1teLV0vLCBDID0+IChjID0gQywgJy0nKSk7XHJcblx0XHRcdHMxID0gczEucmVwbGFjZSgvLSg/IS4qLSkvLCBjKTtcclxuXHRcdH1cclxuXHRcdHJldHVybiBbbmV3IFN6Q29sb3JJdGVtKHMxIGFzIGFueSksIHMyID09ICctLS0nID8gbnVsbCA6IG5ldyBTekNvbG9ySXRlbShzMiBhcyBhbnkpXTtcclxuXHR9XHJcblxyXG5cdHNwbGl0SW50b0NvbG9ycygpOiBbY29sb3IsIGNvbG9yIHwgbnVsbF0ge1xyXG5cdFx0Y29uc3QgdG9jID0gKGM6IHN0cmluZykgPT4gU3pJbmZvLmNvbG9yLmJ5Q2hhcltjXS5uYW1lXHJcblx0XHRsZXQgcyA9IHRoaXMuY29sb3Iuc3BsaXQoJycpLmZpbHRlcihlID0+IGUgIT0gJy0nKTtcclxuXHRcdGlmIChzLmxlbmd0aCA9PSAwKSByZXR1cm4gWydncmV5JywgbnVsbF07XHJcblx0XHRpZiAocy5sZW5ndGggPT0gMSkgcmV0dXJuIFt0b2Moc1swXSksIG51bGxdO1xyXG5cdFx0aWYgKHMubGVuZ3RoID09IDIpIHJldHVybiBbdG9jKHNbMF0pLCB0b2Moc1sxXSldO1xyXG5cdFx0cyA9IHMuc29ydCgpO1xyXG5cdFx0bGV0IGMgPSBTekluZm8uY29sb3IuYnlDb21ib1tzLnNvcnQoKS5qb2luKCcnKSBhcyBjb2xvclN0cmluZ10ubmFtZTtcclxuXHRcdHJldHVybiBbYywgY107XHJcblx0fVxyXG5cclxuXHRzdGF0aWMgaW5zdGFsbChtb2Q6IE1vZCkge1xyXG5cdFx0bW9kLm1vZEludGVyZmFjZS5yZWdpc3Rlckl0ZW0oU3pDb2xvckl0ZW0sIGRhdGEgPT4gbmV3IFN6Q29sb3JJdGVtKGRhdGEpKTtcclxuXHR9XHJcbn0iXX0=