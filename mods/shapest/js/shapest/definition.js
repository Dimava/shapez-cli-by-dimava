import { BasicSerializableObject, COLOR_ITEM_SINGLETONS, globalConfig, LogicGateSystem, makeOffscreenBuffer, ShapeDefinition, smoothenDpi, THEME, types } from "../shapez.js";
import { SzInfo, SzLayer } from "./layer.js";
import { SzContext2D } from "./SzContext2D.js";
export class SzDefinition extends BasicSerializableObject {
    static getId() {
        return "sz-definition";
    }
    static createTest() {
        return new SzDefinition({
            layers: [SzLayer.createTest()],
        });
    }
    constructor(data, clone = false) {
        super();
        if (typeof data == 'string')
            return SzDefinition.fromShortKey(data);
        if (data?.layers)
            this.layers = data.layers.map((e, i) => new SzLayer(e, i));
        if (!this.layers.every(e => e.isNormalized())) {
            this.layers = SzDefinition.createTest().layers;
        }
        // console.log(this.getHash())
        if (clone)
            return;
        if (SzDefinition.definitionCache.has(this.getHash())) {
            return SzDefinition.definitionCache.get(this.getHash());
        }
        console.log(this.getHash());
    }
    layers = [];
    cachedHash = '';
    bufferGenerator;
    getClonedLayers() {
        throw new Error("Method not implemented.");
    }
    isEntirelyEmpty() {
        return this.layers.every(e => e.isEmpty());
    }
    getHash() {
        if (this.cachedHash)
            return this.cachedHash;
        if (!this.layers.length)
            debugger;
        return this.cachedHash = this.layers.map(e => e.getHash()).join(':');
    }
    drawFullSizeOnCanvas(context, size) {
        this.internalGenerateShapeBuffer(null, context, size, size, 1);
    }
    generateAsCanvas(size = 120) {
        const [canvas, context] = makeOffscreenBuffer(size, size, {
            smooth: true,
            label: "definition-canvas-cache-" + this.getHash(),
            reusable: false,
        });
        this.internalGenerateShapeBuffer(canvas, context, size, size, 1);
        return canvas;
    }
    cloneFilteredByQuadrants(includeQuadrants) {
        let layers = this.layers.map(e => e.cloneFilteredByQuadrants(includeQuadrants)).filter(e => !e.isEmpty());
        return new SzDefinition({ layers });
    }
    cloneRotateCW() {
        return new SzDefinition({
            layers: this.layers.map(l => l.clone().rotate(6))
        });
    }
    cloneRotate24(n) {
        return new SzDefinition({
            layers: this.layers.map(l => l.clone().rotate(n))
        });
    }
    cloneRotateCCW() {
        return new SzDefinition({
            layers: this.layers.map(l => l.clone().rotate(24 - 6))
        });
    }
    cloneRotate180() {
        return new SzDefinition({
            layers: this.layers.map(l => l.clone().rotate(12))
        });
    }
    cloneAndStackWith(upper) {
        let bottom = this.clone(e => e.removeCover()).layers;
        let top = upper.clone().layers;
        let dh = 0;
        while (!bottom.every((l, i) => {
            return l.canStackWith(top[i - dh]);
        }))
            dh++;
        let overlap = bottom.length - dh;
        let newLayers = bottom.map((l, i) => {
            return l.stackWith(top[i + dh]);
        }).concat(top.slice(overlap));
        return new SzDefinition({ layers: newLayers.slice(0, 4) });
    }
    cloneAndPaintWith(color) {
        let rawPaints = Array(24).fill(color);
        return this.clone((l, i, a) => {
            let paints = a.slice(i).reduceRight((v, e) => e.filterPaint(v), rawPaints);
            return l.removeCover().paint(paints);
        });
    }
    cloneAndPaintWith4Colors(colors) {
        let rawPaints = Array.from({ length: 24 }, (e, i) => {
            return colors[i % 6];
        });
        return this.clone((l, i, a) => {
            let paints = a.slice(i).reduceRight((v, e) => e.filterPaint(v), rawPaints);
            return l.removeCover().paint(paints);
        });
    }
    cloneAndMakeCover() {
        return new SzDefinition({ layers: this.layers.map(e => e.cloneAsCover()) });
    }
    clone(layerMapper) {
        if (layerMapper) {
            return new SzDefinition({
                layers: this.layers.map(e => e.clone()).flatMap((e, i, a) => {
                    return layerMapper(e, i, a) || [];
                }).filter(e => !e.isEmpty())
            });
        }
        return new SzDefinition(this, true);
    }
    static getSchema() {
        return types.string;
    }
    serialize() {
        return this.getHash();
    }
    deserialize(data, root) {
        console.log('deser', this);
    }
    // inherited
    drawCentered(x, y, parameters, diameter) {
        const dpi = smoothenDpi(globalConfig.shapesSharpness * parameters.zoomLevel);
        if (!this.bufferGenerator) {
            this.bufferGenerator = this.internalGenerateShapeBuffer.bind(this);
        }
        const key = diameter + "/" + dpi + "/" + this.cachedHash;
        const canvas = parameters.root.buffers.getForKey({
            key: "shapedef",
            subKey: key,
            w: diameter,
            h: diameter,
            dpi,
            redrawMethod: this.bufferGenerator,
        });
        parameters.context.drawImage(canvas, x - diameter / 2, y - diameter / 2, diameter, diameter);
    }
    internalGenerateShapeBuffer(canvas, ctx, w, h, dpi) {
        // prepare context
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';
        ctx.lineWidth = 0.05;
        ctx.translate((w * dpi) / 2, (h * dpi) / 2);
        ctx.scale((dpi * w) / 2.3, (dpi * h) / 2.3);
        ctx.lineCap = 'round';
        ctx.lineJoin = 'round';
        ctx.strokeStyle = THEME.items.outline;
        ctx.lineWidth = THEME.items.outlineWidth / 10;
        ctx.rotate(-Math.PI / 2);
        ctx.fillStyle = THEME.items.circleBackground;
        ctx.beginPath();
        ctx.arc(0, 0, 1.15, 0, 2 * Math.PI);
        ctx.fill();
        let sCtx = new SzContext2D(ctx);
        this.layers.forEach((l, i) => l.drawCenteredLayerScaled(sCtx, i));
    }
    static rawHashMap = new Map();
    static getHashfromRawHash(hash) {
        if (!this.rawHashMap.has(hash)) {
            this.rawHashMap.set(hash, hash.startsWith('sz!') ? SzDefinition.fromShortKey(hash).getHash() :
                SzDefinition.fromRawShape(hash).getHash());
        }
        return this.rawHashMap.get(hash);
    }
    static fromRawShape(shapeDefinition) {
        if (typeof shapeDefinition != 'string')
            shapeDefinition = shapeDefinition.getHash();
        return new SzDefinition({
            layers: shapeDefinition.split(':').map(e => SzLayer.fromShortKey(e))
        });
    }
    static definitionCache = new Map();
    static fromShortKey(key) {
        if (!this.definitionCache.has(key)) {
            this.definitionCache.set(key, new SzDefinition({
                layers: key.split(':').map(e => SzLayer.fromShortKey(e))
            }));
        }
        return this.definitionCache.get(key);
    }
    compute_ANALYZE(root) {
        let firstQuad = this.layers[0].quads[0];
        if (firstQuad.from != 0)
            return [null, null];
        let definition = new SzDefinition({ layers: [SzInfo.quad.exampleLayer(firstQuad.shape)] });
        // @ts-expect-error
        let color = enumShortcodeToColor[SzInfo.color.byName[firstQuad.color].code];
        return [
            COLOR_ITEM_SINGLETONS[color],
            root.shapeDefinitionMgr.getShapeItemFromDefinition(definition),
        ];
    }
    static install(mod) {
        mod.modInterface.extendObject(ShapeDefinition, ({ $old }) => ({
            fromShortKey: SzDefinition.fromShortKey.bind(SzDefinition)
        }));
        mod.modInterface.extendClass(LogicGateSystem, ({ $old }) => ({
            compute_ANALYZE(parameters) {
                let item = parameters[0];
                if (!item || item.getItemType() !== "shape") {
                    // Not a shape
                    return [null, null];
                }
                let def = item.definition;
                if (def instanceof SzDefinition) {
                    return def.compute_ANALYZE(this.root);
                }
                return $old.compute_ANALYZE.call(this, parameters);
            }
        }));
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGVmaW5pdGlvbi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3RzL3NoYXBlc3QvZGVmaW5pdGlvbi50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFFQSxPQUFPLEVBQVksdUJBQXVCLEVBQUUscUJBQXFCLEVBQTRCLFlBQVksRUFBRSxlQUFlLEVBQUUsbUJBQW1CLEVBQU8sZUFBZSxFQUF5QixXQUFXLEVBQUUsS0FBSyxFQUFFLEtBQUssRUFBRSxNQUFNLGNBQWMsQ0FBQztBQUM5TyxPQUFPLEVBQVMsTUFBTSxFQUFFLE9BQU8sRUFBRSxNQUFNLFlBQVksQ0FBQztBQUNwRCxPQUFPLEVBQXFCLFdBQVcsRUFBRSxNQUFNLGtCQUFrQixDQUFDO0FBR2xFLE1BQU0sT0FBTyxZQUFhLFNBQVEsdUJBQXVCO0lBQ3hELE1BQU0sQ0FBQyxLQUFLO1FBQ1gsT0FBTyxlQUFlLENBQUM7SUFDeEIsQ0FBQztJQUVELE1BQU0sQ0FBQyxVQUFVO1FBQ2hCLE9BQU8sSUFBSSxZQUFZLENBQUM7WUFDdkIsTUFBTSxFQUFFLENBQUMsT0FBTyxDQUFDLFVBQVUsRUFBRSxDQUFDO1NBQzlCLENBQUMsQ0FBQztJQUNKLENBQUM7SUFJRCxZQUFZLElBQW9ELEVBQUUsS0FBSyxHQUFHLEtBQUs7UUFDOUUsS0FBSyxFQUFFLENBQUM7UUFDUixJQUFJLE9BQU8sSUFBSSxJQUFJLFFBQVE7WUFBRSxPQUFPLFlBQVksQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDLENBQUM7UUFDcEUsSUFBSSxJQUFJLEVBQUUsTUFBTTtZQUFFLElBQUksQ0FBQyxNQUFNLEdBQUcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxJQUFJLE9BQU8sQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUM3RSxJQUFJLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLEVBQUUs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QkFBa0IsQ0FBQywwQkFBMEIsQ0FBQyxVQUFVLENBQUM7U0FDOUQsQ0FBQztJQUNILENBQUM7SUFJRCxNQUFNLENBQUMsT0FBTyxDQUFDLEdBQVE7UUFDdEIsR0FBRyxDQUFDLFlBQVksQ0FBQyxZQUFZLENBQUMsZUFBZSxFQUFFLENBQUMsRUFBRSxJQUFJLEVBQUUsRUFBRSxFQUFFLENBQUMsQ0FBQztZQUM3RCxZQUFZLEVBQUUsWUFBWSxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDO1NBQzFELENBQUMsQ0FBQyxDQUFDO1FBRUosR0FBRyxDQUFDLFlBQVksQ0FBQyxXQUFXLENBQUMsZUFBZSxFQUFFLENBQUMsRUFBRSxJQUFJLEVBQUUsRUFBRSxFQUFFLENBQUMsQ0FBQztZQUM1RCxlQUFlLENBQUMsVUFBZTtnQkFDOUIsSUFBSSxJQUFJLEdBQUcsVUFBVSxDQUFDLENBQUMsQ0FBQyxDQUFDO2dCQUN6QixJQUFJLENBQUMsSUFBSSxJQUFJLElBQUksQ0FBQyxXQUFXLEVBQUUsS0FBSyxPQUFPLEVBQUU7b0JBQzVDLGNBQWM7b0JBQ2QsT0FBTyxDQUFDLElBQXVCLEVBQUUsSUFBdUIsQ0FBQyxDQUFDO2lCQUMxRDtnQkFDRCxJQUFJLEdBQUcsR0FBSSxJQUFrQixDQUFDLFVBQVUsQ0FBQztnQkFDekMsSUFBSSxHQUFHLFlBQVksWUFBWSxFQUFFO29CQUNoQyxPQUFPLEdBQUcsQ0FBQyxlQUFlLENBQUMsSUFBSSxDQUFDLElBQUssQ0FBUSxDQUFDO2lCQUM5QztnQkFDRCxPQUFPLElBQUksQ0FBQyxlQUFlLENBQUMsSUFBSSxDQUFDLElBQUksRUFBRSxVQUFVLENBQUMsQ0FBQztZQUNwRCxDQUFDO1NBQ0QsQ0FBQyxDQUFDLENBQUE7SUFFSixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiXHJcbmltcG9ydCB7IG92ZXJyaWRlLCBzdHJUb0ggfSBmcm9tIFwiLi4vdHlwZXMvY29tbW9uLmpzXCI7XHJcbmltcG9ydCB7IEJhc2VJdGVtLCBCYXNpY1NlcmlhbGl6YWJsZU9iamVjdCwgQ09MT1JfSVRFTV9TSU5HTEVUT05TLCBEcmF3UGFyYW1ldGVycywgR2FtZVJvb3QsIGdsb2JhbENvbmZpZywgTG9naWNHYXRlU3lzdGVtLCBtYWtlT2Zmc2NyZWVuQnVmZmVyLCBNb2QsIFNoYXBlRGVmaW5pdGlvbiwgU2hhcGVJdGVtLCBTaGFwZUxheWVyLCBzbW9vdGhlbkRwaSwgVEhFTUUsIHR5cGVzIH0gZnJvbSBcIi4uL3NoYXBlei5qc1wiO1xyXG5pbXBvcnQgeyBjb2xvciwgU3pJbmZvLCBTekxheWVyIH0gZnJvbSBcIi4vbGF5ZXIuanNcIjtcclxuaW1wb3J0IHsgcm1vZGUsIHJvdGF0aW9uMjQsIFN6Q29udGV4dDJEIH0gZnJvbSBcIi4vU3pDb250ZXh0MkQuanNcIjtcclxuXHJcblxyXG5leHBvcnQgY2xhc3MgU3pEZWZpbml0aW9uIGV4dGVuZHMgQmFzaWNTZXJpYWxpemFibGVPYmplY3QgaW1wbGVtZW50cyBTaGFwZURlZmluaXRpb24ge1xyXG5cdHN0YXRpYyBnZXRJZCgpIHtcclxuXHRcdHJldHVybiBcInN6LWRlZmluaXRpb25cIjtcclxuXHR9XHJcblxyXG5cdHN0YXRpYyBjcmVhdGVUZXN0KCkge1xyXG5cdFx0cmV0dXJuIG5ldyBTekRlZmluaXRpb24oe1xyXG5cdFx0XHRsYXllcnM6IFtTekxheWVyLmNyZWF0ZVRlc3QoKV0sXHJcblx0XHR9KTtcclxuXHR9XHJcblxyXG5cclxuXHJcblx0Y29uc3RydWN0b3IoZGF0YT86IHsgbGF5ZXJzOiBTekxheWVyW10gfSB8IFN6RGVmaW5pdGlvbiB8IHN0cmluZywgY2xvbmUgPSBmYWxzZSkge1xyXG5cdFx0c3VwZXIoKTtcclxuXHRcdGlmICh0eXBlb2YgZGF0YSA9PSAnc3RyaW5nJykgcmV0dXJuIFN6RGVmaW5pdGlvbi5mcm9tU2hvcnRLZXkoZGF0YSk7XHJcblx0XHRpZiAoZGF0YT8ubGF5ZXJzKSB0aGlzLmxheWVycyA9IGRhdGEubGF5ZXJzLm1hcCgoZSwgaSkgPT4gbmV3IFN6TGF5ZXIoZSwgaSkpO1xyXG5cdFx0aWYgKCF0aGlzLmxheWVycy5ldmVyeShlID0+IGUuaXNOb3JtYWxpemVkKCkpKSB7XHJcblx0XHRcdHRoaXMubGF5ZXJzID0gU3pEZWZpbml0aW9uLmNyZWF0ZVRlc3QoKS5sYXllcnM7XHJcblx0XHR9XHJcblx0XHQvLyBjb25zb2xlLmxvZyh0aGlzLmdldEhhc2goKSlcclxuXHRcdGlmIChjbG9uZSkgcmV0dXJuO1xyXG5cdFx0aWYgKFN6RGVmaW5pdGlvbi5kZWZpbml0aW9uQ2FjaGUuaGFzKHRoaXMuZ2V0SGFzaCgpKSkge1xyXG5cdFx0XHRyZXR1cm4gU3pEZWZpbml0aW9uLmRlZmluaXRpb25DYWNoZS5nZXQodGhpcy5nZXRIYXNoKCkpITtcclxuXHRcdH1cclxuXHRcdGNvbnNvbGUubG9nKHRoaXMuZ2V0SGFzaCgpKTtcclxuXHR9XHJcblxyXG5cclxuXHJcblx0bGF5ZXJzOiBTekxheWVyW10gPSBbXTtcclxuXHRjYWNoZWRIYXNoOiBzdHJpbmcgPSAnJztcclxuXHRidWZmZXJHZW5lcmF0b3I6IGFueTtcclxuXHRnZXRDbG9uZWRMYXllcnMoKTogU2hhcGVMYXllcltdIHtcclxuXHRcdHRocm93IG5ldyBFcnJvcihcIk1ldGhvZCBub3QgaW1wbGVtZW50ZWQuXCIpO1xyXG5cdH1cclxuXHRpc0VudGlyZWx5RW1wdHkoKTogYm9vbGVhbiB7XHJcblx0XHRyZXR1cm4gdGhpcy5sYXllcnMuZXZlcnkoZSA9PiBlLmlzRW1wdHkoKSk7XHJcblx0fVxyXG5cdGdldEhhc2goKTogc3RyaW5nIHtcclxuXHRcdGlmICh0aGlzLmNhY2hlZEhhc2gpIHJldHVybiB0aGlzLmNhY2hlZEhhc2g7XHJcblx0XHRpZiAoIXRoaXMubGF5ZXJzLmxlbmd0aCkgZGVidWdnZXI7XHJcblx0XHRyZXR1cm4gdGhpcy5jYWNoZWRIYXNoID0gdGhpcy5sYXllcnMubWFwKGUgPT4gZS5nZXRIYXNoKCkpLmpvaW4oJzonKTtcclxuXHR9XHJcblx0ZHJhd0Z1bGxTaXplT25DYW52YXMoY29udGV4dDogQ2FudmFzUmVuZGVyaW5nQ29udGV4dDJELCBzaXplOiBudW1iZXIpOiB2b2lkIHtcclxuXHRcdHRoaXMuaW50ZXJuYWxHZW5lcmF0ZVNoYXBlQnVmZmVyKG51bGwgYXMgYW55LCBjb250ZXh0LCBzaXplLCBzaXplLCAxKTtcclxuXHR9XHJcblx0Z2VuZXJhdGVBc0NhbnZhcyhzaXplID0gMTIwKSB7XHJcblx0XHRjb25zdCBbY2FudmFzLCBjb250ZXh0XSA9IG1ha2VPZmZzY3JlZW5CdWZmZXIoc2l6ZSwgc2l6ZSwge1xyXG5cdFx0XHRzbW9vdGg6IHRydWUsXHJcblx0XHRcdGxhYmVsOiBcImRlZmluaXRpb24tY2FudmFzLWNhY2hlLVwiICsgdGhpcy5nZXRIYXNoKCksXHJcblx0XHRcdHJldXNhYmxlOiBmYWxzZSxcclxuXHRcdH0pO1xyXG5cclxuXHRcdHRoaXMuaW50ZXJuYWxHZW5lcmF0ZVNoYXBlQnVmZmVyKGNhbnZhcywgY29udGV4dCwgc2l6ZSwgc2l6ZSwgMSk7XHJcblx0XHRyZXR1cm4gY2FudmFzO1xyXG5cdH1cclxuXHRjbG9uZUZpbHRlcmVkQnlRdWFkcmFudHMoaW5jbHVkZVF1YWRyYW50czogbnVtYmVyW10pOiBTaGFwZURlZmluaXRpb24ge1xyXG5cdFx0bGV0IGxheWVycyA9IHRoaXMubGF5ZXJzLm1hcChlID0+IGUuY2xvbmVGaWx0ZXJlZEJ5UXVhZHJhbnRzKGluY2x1ZGVRdWFkcmFudHMpKS5maWx0ZXIoZSA9PiAhZS5pc0VtcHR5KCkpO1xyXG5cdFx0cmV0dXJuIG5ldyBTekRlZmluaXRpb24oeyBsYXllcnMgfSk7XHJcblx0fVxyXG5cdGNsb25lUm90YXRlQ1coKTogU2hhcGVEZWZpbml0aW9uIHtcclxuXHRcdHJldHVybiBuZXcgU3pEZWZpbml0aW9uKHtcclxuXHRcdFx0bGF5ZXJzOiB0aGlzLmxheWVycy5tYXAobCA9PiBsLmNsb25lKCkucm90YXRlKDYpKVxyXG5cdFx0fSk7XHJcblx0fVxyXG5cdGNsb25lUm90YXRlMjQobjogcm90YXRpb24yNCk6IFN6RGVmaW5pdGlvbiB7XHJcblx0XHRyZXR1cm4gbmV3IFN6RGVmaW5pdGlvbih7XHJcblx0XHRcdGxheWVyczogdGhpcy5sYXllcnMubWFwKGwgPT4gbC5jbG9uZSgpLnJvdGF0ZShuKSlcclxuXHRcdH0pO1xyXG5cdH1cclxuXHRjbG9uZVJvdGF0ZUNDVygpOiBTaGFwZURlZmluaXRpb24ge1xyXG5cdFx0cmV0dXJuIG5ldyBTekRlZmluaXRpb24oe1xyXG5cdFx0XHRsYXllcnM6IHRoaXMubGF5ZXJzLm1hcChsID0+IGwuY2xvbmUoKS5yb3RhdGUoMjQgLSA2KSlcclxuXHRcdH0pO1xyXG5cdH1cclxuXHRjbG9uZVJvdGF0ZTE4MCgpOiBTaGFwZURlZmluaXRpb24ge1xyXG5cdFx0cmV0dXJuIG5ldyBTekRlZmluaXRpb24oe1xyXG5cdFx0XHRsYXllcnM6IHRoaXMubGF5ZXJzLm1hcChsID0+IGwuY2xvbmUoKS5yb3RhdGUoMTIpKVxyXG5cdFx0fSk7XHJcblx0fVxyXG5cdGNsb25lQW5kU3RhY2tXaXRoKHVwcGVyOiBTekRlZmluaXRpb24pOiBTaGFwZURlZmluaXRpb24ge1xyXG5cdFx0bGV0IGJvdHRvbSA9IHRoaXMuY2xvbmUoZSA9PiBlLnJlbW92ZUNvdmVyKCkpLmxheWVycztcclxuXHRcdGxldCB0b3AgPSB1cHBlci5jbG9uZSgpLmxheWVycztcclxuXHRcdGxldCBkaCA9IDA7XHJcblx0XHR3aGlsZSAoIWJvdHRvbS5ldmVyeSgobCwgaSkgPT4ge1xyXG5cdFx0XHRyZXR1cm4gbC5jYW5TdGFja1dpdGgodG9wW2kgLSBkaF0pO1xyXG5cdFx0fSkpIGRoKys7XHJcblx0XHRsZXQgb3ZlcmxhcCA9IGJvdHRvbS5sZW5ndGggLSBkaDtcclxuXHRcdGxldCBuZXdMYXllcnMgPSBib3R0b20ubWFwKChsLCBpKSA9PiB7XHJcblx0XHRcdHJldHVybiBsLnN0YWNrV2l0aCh0b3BbaSArIGRoXSk7XHJcblx0XHR9KS5jb25jYXQodG9wLnNsaWNlKFxyXG5cdFx0XHRvdmVybGFwXHJcblx0XHQpKTtcclxuXHRcdHJldHVybiBuZXcgU3pEZWZpbml0aW9uKHsgbGF5ZXJzOiBuZXdMYXllcnMuc2xpY2UoMCwgNCkgfSk7XHJcblx0fVxyXG5cclxuXHRjbG9uZUFuZFBhaW50V2l0aChjb2xvcjogY29sb3IpOiBTekRlZmluaXRpb24ge1xyXG5cdFx0bGV0IHJhd1BhaW50cyA9IEFycmF5PGNvbG9yIHwgbnVsbD4oMjQpLmZpbGwoY29sb3IpO1xyXG5cdFx0cmV0dXJuIHRoaXMuY2xvbmUoKGwsIGksIGEpID0+IHtcclxuXHRcdFx0bGV0IHBhaW50cyA9IGEuc2xpY2UoaSkucmVkdWNlUmlnaHQoKHYsIGUpID0+IGUuZmlsdGVyUGFpbnQodiksIHJhd1BhaW50cyk7XHJcblx0XHRcdHJldHVybiBsLnJlbW92ZUNvdmVyKCkucGFpbnQocGFpbnRzKTtcclxuXHRcdH0pO1xyXG5cdH1cclxuXHJcblx0Y2xvbmVBbmRQYWludFdpdGg0Q29sb3JzKGNvbG9yczogW3N0cmluZywgc3RyaW5nLCBzdHJpbmcsIHN0cmluZ10pOiBTaGFwZURlZmluaXRpb24ge1xyXG5cdFx0bGV0IHJhd1BhaW50czogKGNvbG9yIHwgbnVsbClbXSA9IEFycmF5LmZyb20oeyBsZW5ndGg6IDI0IH0sIChlLCBpKSA9PiB7XHJcblx0XHRcdHJldHVybiBjb2xvcnNbaSAlIDZdIGFzIGFueTtcclxuXHRcdH0pXHJcblx0XHRyZXR1cm4gdGhpcy5jbG9uZSgobCwgaSwgYSkgPT4ge1xyXG5cdFx0XHRsZXQgcGFpbnRzID0gYS5zbGljZShpKS5yZWR1Y2VSaWdodCgodiwgZSkgPT4gZS5maWx0ZXJQYWludCh2KSwgcmF3UGFpbnRzKTtcclxuXHRcdFx0cmV0dXJuIGwucmVtb3ZlQ292ZXIoKS5wYWludChwYWludHMpO1xyXG5cdFx0fSk7XHJcblx0fVxyXG5cclxuXHRjbG9uZUFuZE1ha2VDb3ZlcigpIHtcclxuXHRcdHJldHVybiBuZXcgU3pEZWZpbml0aW9uKHsgbGF5ZXJzOiB0aGlzLmxheWVycy5tYXAoZSA9PiBlLmNsb25lQXNDb3ZlcigpKSB9KVxyXG5cdH1cclxuXHJcblxyXG5cdGNsb25lKGxheWVyTWFwcGVyPzogKGxheWVyOiBTekxheWVyLCBpOiBudW1iZXIsIGE6IFN6TGF5ZXJbXSkgPT4gU3pMYXllciB8IFN6TGF5ZXJbXSB8IG51bGwpIHtcclxuXHRcdGlmIChsYXllck1hcHBlcikge1xyXG5cdFx0XHRyZXR1cm4gbmV3IFN6RGVmaW5pdGlvbih7XHJcblx0XHRcdFx0bGF5ZXJzOiB0aGlzLmxheWVycy5tYXAoZSA9PiBlLmNsb25lKCkpLmZsYXRNYXAoKGUsIGksIGEpID0+IHtcclxuXHRcdFx0XHRcdHJldHVybiBsYXllck1hcHBlcihlLCBpLCBhKSB8fCBbXTtcclxuXHRcdFx0XHR9KS5maWx0ZXIoZSA9PiAhZS5pc0VtcHR5KCkpXHJcblx0XHRcdH0pO1xyXG5cdFx0fVxyXG5cdFx0cmV0dXJuIG5ldyBTekRlZmluaXRpb24odGhpcywgdHJ1ZSk7XHJcblx0fVxyXG5cclxuXHRzdGF0aWMgZ2V0U2NoZW1hKCkge1xyXG5cdFx0cmV0dXJuIHR5cGVzLnN0cmluZztcclxuXHR9XHJcblx0c2VyaWFsaXplKCkge1xyXG5cdFx0cmV0dXJuIHRoaXMuZ2V0SGFzaCgpO1xyXG5cdH1cclxuXHRkZXNlcmlhbGl6ZShkYXRhOiBhbnksIHJvb3Q/OiBHYW1lUm9vdCk6IHN0cmluZyB8IHZvaWQge1xyXG5cdFx0Y29uc29sZS5sb2coJ2Rlc2VyJywgdGhpcyk7XHJcblx0fVxyXG5cclxuXHJcblxyXG5cclxuXHQvLyBpbmhlcml0ZWRcclxuXHRkcmF3Q2VudGVyZWQoeDogbnVtYmVyLCB5OiBudW1iZXIsIHBhcmFtZXRlcnM6IERyYXdQYXJhbWV0ZXJzLCBkaWFtZXRlcjogbnVtYmVyKTogdm9pZCB7XHJcblx0XHRjb25zdCBkcGkgPSBzbW9vdGhlbkRwaShnbG9iYWxDb25maWcuc2hhcGVzU2hhcnBuZXNzICogcGFyYW1ldGVycy56b29tTGV2ZWwpO1xyXG5cdFx0aWYgKCF0aGlzLmJ1ZmZlckdlbmVyYXRvcikge1xyXG5cdFx0XHR0aGlzLmJ1ZmZlckdlbmVyYXRvciA9IHRoaXMuaW50ZXJuYWxHZW5lcmF0ZVNoYXBlQnVmZmVyLmJpbmQodGhpcyk7XHJcblx0XHR9XHJcblx0XHRjb25zdCBrZXkgPSBkaWFtZXRlciArIFwiL1wiICsgZHBpICsgXCIvXCIgKyB0aGlzLmNhY2hlZEhhc2g7XHJcblx0XHRjb25zdCBjYW52YXMgPSBwYXJhbWV0ZXJzLnJvb3QuYnVmZmVycy5nZXRGb3JLZXkoe1xyXG5cdFx0XHRrZXk6IFwic2hhcGVkZWZcIixcclxuXHRcdFx0c3ViS2V5OiBrZXksXHJcblx0XHRcdHc6IGRpYW1ldGVyLFxyXG5cdFx0XHRoOiBkaWFtZXRlcixcclxuXHRcdFx0ZHBpLFxyXG5cdFx0XHRyZWRyYXdNZXRob2Q6IHRoaXMuYnVmZmVyR2VuZXJhdG9yLFxyXG5cdFx0fSk7XHJcblx0XHRwYXJhbWV0ZXJzLmNvbnRleHQuZHJhd0ltYWdlKGNhbnZhcywgeCAtIGRpYW1ldGVyIC8gMiwgeSAtIGRpYW1ldGVyIC8gMiwgZGlhbWV0ZXIsIGRpYW1ldGVyKTtcclxuXHR9XHJcblxyXG5cclxuXHRpbnRlcm5hbEdlbmVyYXRlU2hhcGVCdWZmZXIoY2FudmFzOiBIVE1MQ2FudmFzRWxlbWVudCwgY3R4OiBDYW52YXNSZW5kZXJpbmdDb250ZXh0MkQsIHc6IG51bWJlciwgaDogbnVtYmVyLCBkcGk6IG51bWJlcik6IHZvaWQge1xyXG5cdFx0Ly8gcHJlcGFyZSBjb250ZXh0XHJcblx0XHRjdHgubGluZUNhcCA9ICdyb3VuZCc7XHJcblx0XHRjdHgubGluZUpvaW4gPSAncm91bmQnO1xyXG5cdFx0Y3R4LmxpbmVXaWR0aCA9IDAuMDU7XHJcblxyXG5cdFx0Y3R4LnRyYW5zbGF0ZSgodyAqIGRwaSkgLyAyLCAoaCAqIGRwaSkgLyAyKTtcclxuXHRcdGN0eC5zY2FsZSgoZHBpICogdykgLyAyLjMsIChkcGkgKiBoKSAvIDIuMyk7XHJcblx0XHRjdHgubGluZUNhcCA9ICdyb3VuZCc7XHJcblx0XHRjdHgubGluZUpvaW4gPSAncm91bmQnO1xyXG5cdFx0Y3R4LnN0cm9rZVN0eWxlID0gVEhFTUUuaXRlbXMub3V0bGluZTtcclxuXHRcdGN0eC5saW5lV2lkdGggPSBUSEVNRS5pdGVtcy5vdXRsaW5lV2lkdGggLyAxMDtcclxuXHJcblx0XHRjdHgucm90YXRlKC1NYXRoLlBJIC8gMik7XHJcblxyXG5cdFx0Y3R4LmZpbGxTdHlsZSA9IFRIRU1FLml0ZW1zLmNpcmNsZUJhY2tncm91bmQ7XHJcblx0XHRjdHguYmVnaW5QYXRoKCk7XHJcblx0XHRjdHguYXJjKDAsIDAsIDEuMTUsIDAsIDIgKiBNYXRoLlBJKTtcclxuXHRcdGN0eC5maWxsKCk7XHJcblxyXG5cdFx0bGV0IHNDdHggPSBuZXcgU3pDb250ZXh0MkQoY3R4KTtcclxuXHRcdHRoaXMubGF5ZXJzLmZvckVhY2goKGwsIGkpID0+IGwuZHJhd0NlbnRlcmVkTGF5ZXJTY2FsZWQoc0N0eCwgaSkpO1xyXG5cclxuXHR9XHJcblxyXG5cdHN0YXRpYyByYXdIYXNoTWFwOiBNYXA8c3RyaW5nLCBzdHJpbmc+ID0gbmV3IE1hcCgpO1xyXG5cdHN0YXRpYyBnZXRIYXNoZnJvbVJhd0hhc2goaGFzaDogc3RyaW5nKSB7XHJcblx0XHRpZiAoIXRoaXMucmF3SGFzaE1hcC5oYXMoaGFzaCkpIHtcclxuXHRcdFx0dGhpcy5yYXdIYXNoTWFwLnNldChoYXNoLFxyXG5cdFx0XHRcdGhhc2guc3RhcnRzV2l0aCgnc3ohJykgPyBTekRlZmluaXRpb24uZnJvbVNob3J0S2V5KGhhc2gpLmdldEhhc2goKSA6XHJcblx0XHRcdFx0XHRTekRlZmluaXRpb24uZnJvbVJhd1NoYXBlKGhhc2gpLmdldEhhc2goKVxyXG5cdFx0XHQpXHJcblx0XHR9XHJcblx0XHRyZXR1cm4gdGhpcy5yYXdIYXNoTWFwLmdldChoYXNoKSE7XHJcblx0fVxyXG5cclxuXHRzdGF0aWMgZnJvbVJhd1NoYXBlKHNoYXBlRGVmaW5pdGlvbjogU2hhcGVEZWZpbml0aW9uIHwgc3RyaW5nKSB7XHJcblx0XHRpZiAodHlwZW9mIHNoYXBlRGVmaW5pdGlvbiAhPSAnc3RyaW5nJylcclxuXHRcdFx0c2hhcGVEZWZpbml0aW9uID0gc2hhcGVEZWZpbml0aW9uLmdldEhhc2goKTtcclxuXHRcdHJldHVybiBuZXcgU3pEZWZpbml0aW9uKHtcclxuXHRcdFx0bGF5ZXJzOiBzaGFwZURlZmluaXRpb24uc3BsaXQoJzonKS5tYXAoZSA9PiBTekxheWVyLmZyb21TaG9ydEtleShlKSlcclxuXHRcdH0pO1xyXG5cdH1cclxuXHJcblx0c3RhdGljIGRlZmluaXRpb25DYWNoZTogTWFwPHN0cmluZywgU3pEZWZpbml0aW9uPiA9IG5ldyBNYXAoKTtcclxuXHRzdGF0aWMgZnJvbVNob3J0S2V5KGtleTogc3RyaW5nKTogU3pEZWZpbml0aW9uIHtcclxuXHRcdGlmICghdGhpcy5kZWZpbml0aW9uQ2FjaGUuaGFzKGtleSkpIHtcclxuXHRcdFx0dGhpcy5kZWZpbml0aW9uQ2FjaGUuc2V0KGtleSwgbmV3IFN6RGVmaW5pdGlvbih7XHJcblx0XHRcdFx0bGF5ZXJzOiBrZXkuc3BsaXQoJzonKS5tYXAoZSA9PiBTekxheWVyLmZyb21TaG9ydEtleShlKSlcclxuXHRcdFx0fSkpO1xyXG5cdFx0fVxyXG5cdFx0cmV0dXJuIHRoaXMuZGVmaW5pdGlvbkNhY2hlLmdldChrZXkpITtcclxuXHR9XHJcblxyXG5cdGNvbXB1dGVfQU5BTFlaRShyb290OiBHYW1lUm9vdCk6IFtCYXNlSXRlbSB8IG51bGwsIEJhc2VJdGVtIHwgbnVsbF0ge1xyXG5cdFx0bGV0IGZpcnN0UXVhZCA9IHRoaXMubGF5ZXJzWzBdLnF1YWRzWzBdO1xyXG5cdFx0aWYgKGZpcnN0UXVhZC5mcm9tICE9IDApIHJldHVybiBbbnVsbCwgbnVsbF07XHJcblx0XHRsZXQgZGVmaW5pdGlvbiA9IG5ldyBTekRlZmluaXRpb24oeyBsYXllcnM6IFtTekluZm8ucXVhZC5leGFtcGxlTGF5ZXIoZmlyc3RRdWFkLnNoYXBlKV0gfSk7XHJcblx0XHQvLyBAdHMtZXhwZWN0LWVycm9yXHJcblx0XHRsZXQgY29sb3IgPSBlbnVtU2hvcnRjb2RlVG9Db2xvcltTekluZm8uY29sb3IuYnlOYW1lW2ZpcnN0UXVhZC5jb2xvcl0uY29kZV07XHJcblx0XHRyZXR1cm4gW1xyXG5cdFx0XHRDT0xPUl9JVEVNX1NJTkdMRVRPTlNbY29sb3JdLFxyXG5cdFx0XHRyb290LnNoYXBlRGVmaW5pdGlvbk1nci5nZXRTaGFwZUl0ZW1Gcm9tRGVmaW5pdGlvbihkZWZpbml0aW9uKSxcclxuXHRcdF07XHJcblx0fVxyXG5cclxuXHJcblxyXG5cdHN0YXRpYyBpbnN0YWxsKG1vZDogTW9kKSB7XHJcblx0XHRtb2QubW9kSW50ZXJmYWNlLmV4dGVuZE9iamVjdChTaGFwZURlZmluaXRpb24sICh7ICRvbGQgfSkgPT4gKHtcclxuXHRcdFx0ZnJvbVNob3J0S2V5OiBTekRlZmluaXRpb24uZnJvbVNob3J0S2V5LmJpbmQoU3pEZWZpbml0aW9uKVxyXG5cdFx0fSkpO1xyXG5cclxuXHRcdG1vZC5tb2RJbnRlcmZhY2UuZXh0ZW5kQ2xhc3MoTG9naWNHYXRlU3lzdGVtLCAoeyAkb2xkIH0pID0+ICh7XHJcblx0XHRcdGNvbXB1dGVfQU5BTFlaRShwYXJhbWV0ZXJzOiBhbnkpIHtcclxuXHRcdFx0XHRsZXQgaXRlbSA9IHBhcmFtZXRlcnNbMF07XHJcblx0XHRcdFx0aWYgKCFpdGVtIHx8IGl0ZW0uZ2V0SXRlbVR5cGUoKSAhPT0gXCJzaGFwZVwiKSB7XHJcblx0XHRcdFx0XHQvLyBOb3QgYSBzaGFwZVxyXG5cdFx0XHRcdFx0cmV0dXJuIFtudWxsIGFzIGFueSBhcyBCYXNlSXRlbSwgbnVsbCBhcyBhbnkgYXMgQmFzZUl0ZW1dO1xyXG5cdFx0XHRcdH1cclxuXHRcdFx0XHRsZXQgZGVmID0gKGl0ZW0gYXMgU2hhcGVJdGVtKS5kZWZpbml0aW9uO1xyXG5cdFx0XHRcdGlmIChkZWYgaW5zdGFuY2VvZiBTekRlZmluaXRpb24pIHtcclxuXHRcdFx0XHRcdHJldHVybiBkZWYuY29tcHV0ZV9BTkFMWVpFKHRoaXMucm9vdCEpIGFzIGFueTtcclxuXHRcdFx0XHR9XHJcblx0XHRcdFx0cmV0dXJuICRvbGQuY29tcHV0ZV9BTkFMWVpFLmNhbGwodGhpcywgcGFyYW1ldGVycyk7XHJcblx0XHRcdH1cclxuXHRcdH0pKVxyXG5cclxuXHR9XHJcbn1cclxuXHJcbiJdfQ==