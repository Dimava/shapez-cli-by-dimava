import { SzColorItem } from "../shapest/color.js";
import { SzShapeItem } from "../shapest/item.js";
import { ColorItem, defaultBuildingVariant, enumDirection, enumPainterVariants, MetaPainterBuilding, MOD_ITEM_PROCESSOR_HANDLERS, ShapeItem, Vector } from "../shapez.js";
export class PainterOverride extends MetaPainterBuilding {
    static processPayload(payload) {
        const shapeItem = payload.items.get(0);
        const colorItem = payload.items.get(1);
        function push(v) { payload.outItems.push(v); }
        const paint = (si, color) => this.root.shapeDefinitionMgr.getShapeItemFromDefinition(this.root.shapeDefinitionMgr.shapeActionPaintWith(si.definition, color));
        if (shapeItem instanceof ShapeItem || shapeItem instanceof SzShapeItem) {
            if (colorItem instanceof ColorItem) {
                push({ item: paint(shapeItem, colorItem.color), requiredSlot: 0 });
            }
            else {
                let [color, outColor] = colorItem.splitColor();
                push({ item: paint(shapeItem, color), requiredSlot: 0 });
                if (outColor)
                    push({ item: outColor, requiredSlot: 1, doNotTrack: true });
            }
        }
        else if (shapeItem instanceof SzColorItem) {
            if (colorItem instanceof SzColorItem) {
                let [c1, c2] = shapeItem.fillFromColor(colorItem);
                push({ item: c1, requiredSlot: 0 });
                if (c2)
                    push({ item: c2, requiredSlot: 1, doNotTrack: true });
            }
        }
    }
    static processPayload2(payload) {
        function push(v) { payload.outItems.push(v); }
        const paint = (si, color) => !color ? si :
            this.root.shapeDefinitionMgr.getShapeItemFromDefinition(this.root.shapeDefinitionMgr.shapeActionPaintWith(si.definition, color));
        const shapeItem1 = payload.items.get(0);
        const shapeItem2 = payload.items.get(1);
        const colorItem = payload.items.get(2);
        if (colorItem instanceof ColorItem) {
            push({ item: paint(shapeItem1, colorItem.color) });
            push({ item: shapeItem1 });
            return;
        }
        let [c1, c2] = colorItem.splitIntoColors();
        push({ item: paint(shapeItem1, c1) });
        push({ item: paint(shapeItem2, c2) });
    }
    static install(mod) {
        MOD_ITEM_PROCESSOR_HANDLERS.painter = this.processPayload;
        MOD_ITEM_PROCESSOR_HANDLERS.painterDouble = this.processPayload2;
        mod.modInterface.extendClass(MetaPainterBuilding, ({ $old }) => ({
            updateVariants(entity, rotationVariant, variant) {
                $old.updateVariants.call(this, entity, rotationVariant, variant);
                if (variant == defaultBuildingVariant) {
                    entity.components.ItemEjector.setSlots([
                        { pos: new Vector(1, 0), direction: enumDirection.right },
                        { pos: new Vector(1, 0), direction: enumDirection.bottom },
                    ]);
                    entity.components.ItemAcceptor.setSlots([
                        { pos: new Vector(0, 0), direction: enumDirection.left },
                        { pos: new Vector(1, 0), direction: enumDirection.top, filter: "color" },
                    ]);
                }
                if (variant == enumPainterVariants.mirrored) {
                    entity.components.ItemEjector.setSlots([
                        { pos: new Vector(1, 0), direction: enumDirection.right },
                        { pos: new Vector(1, 0), direction: enumDirection.top },
                    ]);
                    entity.components.ItemAcceptor.setSlots([
                        { pos: new Vector(0, 0), direction: enumDirection.left },
                        { pos: new Vector(1, 0), direction: enumDirection.bottom, filter: "color" },
                    ]);
                }
            },
        }));
        // mod.modInterface.addVariantToExistingBuilding
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicGFpbnRlck92ZXJyaWRlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vdHMvYnVpbGRpbmdzL3BhaW50ZXJPdmVycmlkZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsV0FBVyxFQUFFLE1BQU0scUJBQXFCLENBQUM7QUFDbEQsT0FBTyxFQUFFLFdBQVcsRUFBRSxNQUFNLG9CQUFvQixDQUFDO0FBQ2pELE9BQU8sRUFBRSxTQUFTLEVBQUUsc0JBQXNCLEVBQUUsYUFBYSxFQUFFLG1CQUFtQixFQUF1QixtQkFBbUIsRUFBTywyQkFBMkIsRUFBa0MsU0FBUyxFQUFFLE1BQU0sRUFBRSxNQUFNLGNBQWMsQ0FBQztBQUVwTyxNQUFNLE9BQU8sZUFBZ0IsU0FBUSxtQkFBbUI7SUFFdkQsTUFBTSxDQUFDLGNBQWMsQ0FBNEIsT0FBdUM7UUFDdkYsTUFBTSxTQUFTLEdBQUcsT0FBTyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFzRCxDQUFDO1FBQzVGLE1BQU0sU0FBUyxHQUFHLE9BQU8sQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBNEIsQ0FBQztRQUNsRSxTQUFTLElBQUksQ0FBQyxDQUE2QixJQUFJLE9BQU8sQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUMxRSxNQUFNLEtBQUssR0FBRyxDQUFDLEVBQTJCLEVBQUUsS0FBYSxFQUFFLEVBQUUsQ0FDNUQsSUFBSSxDQUFDLElBQUksQ0FBQyxrQkFBa0IsQ0FBQywwQkFBMEIsQ0FDdEQsSUFBSSxDQUFDLElBQUksQ0FBQyxrQkFBa0IsQ0FBQyxvQkFBb0IsQ0FBQyxFQUFFLENBQUMsVUFBVSxFQUFFLEtBQUssQ0FBQyxDQUFDLENBQUM7UUFHM0UsSUFBSSxTQUFTLFlBQVksU0FBUyxJQUFJLFNBQVMsWUFBWSxXQUFXLEVBQUU7WUFDdkUsSUFBSSxTQUFTLFlBQVksU0FBUyxFQUFFO2dCQUNu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LEVBQUUsSUFBSSxNQUFNLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxFQUFFLFNBQVMsRUFBRSxhQUFhLENBQUMsS0FBSyxFQUFFO3dCQUN6RCxFQUFFLEdBQUcsRUFBRSxJQUFJLE1BQU0sQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLEVBQUUsU0FBUyxFQUFFLGFBQWEsQ0FBQyxHQUFHLEVBQUU7cUJBQ3ZELENBQUMsQ0FBQztvQkFDSCxNQUFNLENBQUMsVUFBVSxDQUFDLFlBQVksQ0FBQyxRQUFRLENBQUM7d0JBQ3ZDLEVBQUUsR0FBRyxFQUFFLElBQUksTUFBTSxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsRUFBRSxTQUFTLEVBQUUsYUFBYSxDQUFDLElBQUksRUFBRTt3QkFDeEQsRUFBRSxHQUFHLEVBQUUsSUFBSSxNQUFNLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxFQUFFLFNBQVMsRUFBRSxhQUFhLENBQUMsTUFBTSxFQUFFLE1BQU0sRUFBRSxPQUFPLEVBQUU7cUJBQzNFLENBQUMsQ0FBQztpQkFDSDtZQUNGLENBQUM7U0FDRCxDQUFDLENBQUMsQ0FBQztRQUVKLGdEQUFnRDtJQUNqRCxDQUFDO0NBQ0QiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBTekNvbG9ySXRlbSB9IGZyb20gXCIuLi9zaGFwZXN0L2NvbG9yLmpzXCI7XHJcbmltcG9ydCB7IFN6U2hhcGVJdGVtIH0gZnJvbSBcIi4uL3NoYXBlc3QvaXRlbS5qc1wiO1xyXG5pbXBvcnQgeyBDb2xvckl0ZW0sIGRlZmF1bHRCdWlsZGluZ1ZhcmlhbnQsIGVudW1EaXJlY3Rpb24sIGVudW1QYWludGVyVmFyaWFudHMsIEl0ZW1Qcm9jZXNzb3JTeXN0ZW0sIE1ldGFQYWludGVyQnVpbGRpbmcsIE1vZCwgTU9EX0lURU1fUFJPQ0VTU09SX0hBTkRMRVJTLCBQcm9jZXNzb3JJbXBsZW1lbnRhdGlvblBheWxvYWQsIFNoYXBlSXRlbSwgVmVjdG9yIH0gZnJvbSBcIi4uL3NoYXBlei5qc1wiO1xyXG5cclxuZXhwb3J0IGNsYXNzIFBhaW50ZXJPdmVycmlkZSBleHRlbmRzIE1ldGFQYWludGVyQnVpbGRpbmcge1xyXG5cclxuXHRzdGF0aWMgcHJvY2Vzc1BheWxvYWQodGhpczogSXRlbVByb2Nlc3NvclN5c3RlbSwgcGF5bG9hZDogUHJvY2Vzc29ySW1wbGVtZW50YXRpb25QYXlsb2FkKSB7XHJcblx0XHRjb25zdCBzaGFwZUl0ZW0gPSBwYXlsb2FkLml0ZW1zLmdldCgwKSBhcyBTaGFwZUl0ZW0gfCBTelNoYXBlSXRlbSB8IENvbG9ySXRlbSB8IFN6Q29sb3JJdGVtO1xyXG5cdFx0Y29uc3QgY29sb3JJdGVtID0gcGF5bG9hZC5pdGVtcy5nZXQoMSkgYXMgQ29sb3JJdGVtIHwgU3pDb2xvckl0ZW07XHJcblx0XHRmdW5jdGlvbiBwdXNoKHY6IHR5cGVvZiBwYXlsb2FkLm91dEl0ZW1zWzBdKSB7IHBheWxvYWQub3V0SXRlbXMucHVzaCh2KTsgfVxyXG5cdFx0Y29uc3QgcGFpbnQgPSAoc2k6IFNoYXBlSXRlbSB8IFN6U2hhcGVJdGVtLCBjb2xvcjogc3RyaW5nKSA9PlxyXG5cdFx0XHR0aGlzLnJvb3Quc2hhcGVEZWZpbml0aW9uTWdyLmdldFNoYXBlSXRlbUZyb21EZWZpbml0aW9uKFxyXG5cdFx0XHRcdHRoaXMucm9vdC5zaGFwZURlZmluaXRpb25NZ3Iuc2hhcGVBY3Rpb25QYWludFdpdGgoc2kuZGVmaW5pdGlvbiwgY29sb3IpKTtcclxuXHJcblxyXG5cdFx0aWYgKHNoYXBlSXRlbSBpbnN0YW5jZW9mIFNoYXBlSXRlbSB8fCBzaGFwZUl0ZW0gaW5zdGFuY2VvZiBTelNoYXBlSXRlbSkge1xyXG5cdFx0XHRpZiAoY29sb3JJdGVtIGluc3RhbmNlb2YgQ29sb3JJdGVtKSB7XHJcblx0XHRcdFx0cHVzaCh7IGl0ZW06IHBhaW50KHNoYXBlSXRlbSwgY29sb3JJdGVtLmNvbG9yKSwgcmVxdWlyZWRTbG90OiAwIH0pO1xyXG5cdFx0XHR9IGVsc2Uge1xyXG5cdFx0XHRcdGxldCBbY29sb3IsIG91dENvbG9yXSA9IGNvbG9ySXRlbS5zcGxpdENvbG9yKCk7XHJcblx0XHRcdFx0cHVzaCh7IGl0ZW06IHBhaW50KHNoYXBlSXRlbSwgY29sb3IpLCByZXF1aXJlZFNsb3Q6IDAgfSk7XHJcblx0XHRcdFx0aWYgKG91dENvbG9yKVxyXG5cdFx0XHRcdFx0cHVzaCh7IGl0ZW06IG91dENvbG9yLCByZXF1aXJlZFNsb3Q6IDEsIGRvTm90VHJhY2s6IHRydWUgfSk7XHJcblx0XHRcdH1cclxuXHRcdH0gZWxzZSBpZiAoc2hhcGVJdGVtIGluc3RhbmNlb2YgU3pDb2xvckl0ZW0pIHtcclxuXHRcdFx0aWYgKGNvbG9ySXRlbSBpbnN0YW5jZW9mIFN6Q29sb3JJdGVtKSB7XHJcblx0XHRcdFx0bGV0IFtjMSwgYzJdID0gc2hhcGVJdGVtLmZpbGxGcm9tQ29sb3IoY29sb3JJdGVtKTtcclxuXHRcdFx0XHRwdXNoKHsgaXRlbTogYzEsIHJlcXVpcmVkU2xvdDogMCB9KTtcclxuXHRcdFx0XHRpZiAoYzIpIHB1c2goeyBpdGVtOiBjMiwgcmVxdWlyZWRTbG90OiAxLCBkb05vdFRyYWNrOiB0cnVlIH0pO1xyXG5cdFx0XHR9XHJcblx0XHR9XHJcblx0fVxyXG5cclxuXHRzdGF0aWMgcHJvY2Vzc1BheWxvYWQyKHRoaXM6IEl0ZW1Qcm9jZXNzb3JTeXN0ZW0sIHBheWxvYWQ6IFByb2Nlc3NvckltcGxlbWVudGF0aW9uUGF5bG9hZCkge1xyXG5cdFx0ZnVuY3Rpb24gcHVzaCh2OiB0eXBlb2YgcGF5bG9hZC5vdXRJdGVtc1swXSkgeyBwYXlsb2FkLm91dEl0ZW1zLnB1c2godik7IH1cclxuXHRcdGNvbnN0IHBhaW50ID0gKHNpOiBTaGFwZUl0ZW0gfCBTelNoYXBlSXRlbSwgY29sb3I6IHN0cmluZyB8IG51bGwpID0+XHJcblx0XHRcdCFjb2xvciA/IHNpIDpcclxuXHRcdFx0XHR0aGlzLnJvb3Quc2hhcGVEZWZpbml0aW9uTWdyLmdldFNoYXBlSXRlbUZyb21EZWZpbml0aW9uKFxyXG5cdFx0XHRcdFx0dGhpcy5yb290LnNoYXBlRGVmaW5pdGlvbk1nci5zaGFwZUFjdGlvblBhaW50V2l0aChzaS5kZWZpbml0aW9uLCBjb2xvcikpO1xyXG5cclxuXHRcdGNvbnN0IHNoYXBlSXRlbTEgPSBwYXlsb2FkLml0ZW1zLmdldCgwKSBhcyBTaGFwZUl0ZW0gfCBTelNoYXBlSXRlbTtcclxuXHRcdGNvbnN0IHNoYXBlSXRlbTIgPSBwYXlsb2FkLml0ZW1zLmdldCgxKSBhcyBTaGFwZUl0ZW0gfCBTelNoYXBlSXRlbTtcclxuXHRcdGNvbnN0IGNvbG9ySXRlbSA9IHBheWxvYWQuaXRlbXMuZ2V0KDIpIGFzIENvbG9ySXRlbSB8IFN6Q29sb3JJdGVtO1xyXG5cclxuXHRcdGlmIChjb2xvckl0ZW0gaW5zdGFuY2VvZiBDb2xvckl0ZW0pIHtcclxuXHRcdFx0cHVzaCh7IGl0ZW06IHBhaW50KHNoYXBlSXRlbTEsIGNvbG9ySXRlbS5jb2xvcikgfSk7XHJcblx0XHRcdHB1c2goeyBpdGVtOiBzaGFwZUl0ZW0xIH0pO1xyXG5cdFx0XHRyZXR1cm47XHJcblx0XHR9XHJcblx0XHRsZXQgW2MxLCBjMl0gPSBjb2xvckl0ZW0uc3BsaXRJbnRvQ29sb3JzKCk7XHJcblx0XHRwdXNoKHsgaXRlbTogcGFpbnQoc2hhcGVJdGVtMSwgYzEpIH0pO1xyXG5cdFx0cHVzaCh7IGl0ZW06IHBhaW50KHNoYXBlSXRlbTIsIGMyKSB9KTtcclxuXHR9XHJcblxyXG5cclxuXHRzdGF0aWMgaW5zdGFsbChtb2Q6IE1vZCkge1xyXG5cclxuXHRcdE1PRF9JVEVNX1BST0NFU1NPUl9IQU5ETEVSUy5wYWludGVyID0gdGhpcy5wcm9jZXNzUGF5bG9hZDtcclxuXHRcdE1PRF9JVEVNX1BST0NFU1NPUl9IQU5ETEVSUy5wYWludGVyRG91YmxlID0gdGhpcy5wcm9jZXNzUGF5bG9hZDI7XHJcblxyXG5cclxuXHRcdG1vZC5tb2RJbnRlcmZhY2UuZXh0ZW5kQ2xhc3MoTWV0YVBhaW50ZXJCdWlsZGluZywgKHsgJG9sZCB9KSA9PiAoe1xyXG5cdFx0XHR1cGRhdGVWYXJpYW50cyhlbnRpdHk6IHsgY29tcG9uZW50czogeyBJdGVtRWplY3RvcjogeyBzZXRTbG90czogKGFyZzA6IHsgcG9zOiBWZWN0b3I7IGRpcmVjdGlvbjogc3RyaW5nOyB9W10pID0+IHZvaWQ7IH07IEl0ZW1BY2NlcHRvcjogeyBzZXRTbG90czogKGFyZzA6ICh7IHBvczogVmVjdG9yOyBkaXJlY3Rpb246IHN0cmluZzsgZmlsdGVyPzogdW5kZWZpbmVkOyB9IHwgeyBwb3M6IFZlY3RvcjsgZGlyZWN0aW9uOiBzdHJpbmc7IGZpbHRlcjogc3RyaW5nOyB9KVtdKSA9PiB2b2lkOyB9OyB9OyB9LCByb3RhdGlvblZhcmlhbnQ6IGFueSwgdmFyaWFudDogc3RyaW5nKSB7XHJcblx0XHRcdFx0JG9sZC51cGRhdGVWYXJpYW50cy5jYWxsKHRoaXMsIGVudGl0eSwgcm90YXRpb25WYXJpYW50LCB2YXJpYW50KTtcclxuXHRcdFx0XHRpZiAodmFyaWFudCA9PSBkZWZhdWx0QnVpbGRpbmdWYXJpYW50KSB7XHJcblx0XHRcdFx0XHRlbnRpdHkuY29tcG9uZW50cy5JdGVtRWplY3Rvci5zZXRTbG90cyhbXHJcblx0XHRcdFx0XHRcdHsgcG9zOiBuZXcgVmVjdG9yKDEsIDApLCBkaXJlY3Rpb246IGVudW1EaXJlY3Rpb24ucmlnaHQgfSxcclxuXHRcdFx0XHRcdFx0eyBwb3M6IG5ldyBWZWN0b3IoMSwgMCksIGRpcmVjdGlvbjogZW51bURpcmVjdGlvbi5ib3R0b20gfSxcclxuXHRcdFx0XHRcdF0pO1xyXG5cdFx0XHRcdFx0ZW50aXR5LmNvbXBvbmVudHMuSXRlbUFjY2VwdG9yLnNldFNsb3RzKFtcclxuXHRcdFx0XHRcdFx0eyBwb3M6IG5ldyBWZWN0b3IoMCwgMCksIGRpcmVjdGlvbjogZW51bURpcmVjdGlvbi5sZWZ0IH0sXHJcblx0XHRcdFx0XHRcdHsgcG9zOiBuZXcgVmVjdG9yKDEsIDApLCBkaXJlY3Rpb246IGVudW1EaXJlY3Rpb24udG9wLCBmaWx0ZXI6IFwiY29sb3JcIiB9LFxyXG5cdFx0XHRcdFx0XSk7XHJcblx0XHRcdFx0fVxyXG5cdFx0XHRcdGlmICh2YXJpYW50ID09IGVudW1QYWludGVyVmFyaWFudHMubWlycm9yZWQpIHtcclxuXHRcdFx0XHRcdGVudGl0eS5jb21wb25lbnRzLkl0ZW1FamVjdG9yLnNldFNsb3RzKFtcclxuXHRcdFx0XHRcdFx0eyBwb3M6IG5ldyBWZWN0b3IoMSwgMCksIGRpcmVjdGlvbjogZW51bURpcmVjdGlvbi5yaWdodCB9LFxyXG5cdFx0XHRcdFx0XHR7IHBvczogbmV3IFZlY3RvcigxLCAwKSwgZGlyZWN0aW9uOiBlbnVtRGlyZWN0aW9uLnRvcCB9LFxyXG5cdFx0XHRcdFx0XSk7XHJcblx0XHRcdFx0XHRlbnRpdHkuY29tcG9uZW50cy5JdGVtQWNjZXB0b3Iuc2V0U2xvdHMoW1xyXG5cdFx0XHRcdFx0XHR7IHBvczogbmV3IFZlY3RvcigwLCAwKSwgZGlyZWN0aW9uOiBlbnVtRGlyZWN0aW9uLmxlZnQgfSxcclxuXHRcdFx0XHRcdFx0eyBwb3M6IG5ldyBWZWN0b3IoMSwgMCksIGRpcmVjdGlvbjogZW51bURpcmVjdGlvbi5ib3R0b20sIGZpbHRlcjogXCJjb2xvclwiIH0sXHJcblx0XHRcdFx0XHRdKTtcclxuXHRcdFx0XHR9XHJcblx0XHRcdH0sXHJcblx0XHR9KSk7XHJcblxyXG5cdFx0Ly8gbW9kLm1vZEludGVyZmFjZS5hZGRWYXJpYW50VG9FeGlzdGluZ0J1aWxkaW5nXHJcblx0fVxyXG59Il19